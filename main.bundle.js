(()=>{var t,e,s,n,o={8860:(t,e,s)=>{"use strict";s.r(e)},266:(t,e,s)=>{var n={"./G_Clef.png":2578,"./Mario.png":9410,"./about.png":3236,"./beat_button.png":7997,"./bomb.png":7712,"./character_sheet.png":7246,"./clear_button.png":9179,"./end_mark.png":3295,"./loading_transparent_.gif":1413,"./mario_sweat.png":6206,"./mat.png":9113,"./numbers.png":3944,"./play_button.png":9890,"./repeat_head.png":2788,"./semitone.png":6244,"./share.png":540,"./slider_thumb.png":9513,"./song_buttons.png":1719,"./stop_button.png":8032,"./undo_dog.png":3443};function o(t){var e=i(t);return s(e)}function i(t){if(!s.o(n,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return n[t]}o.keys=function(){return Object.keys(n)},o.resolve=i,t.exports=o,o.id=266},7518:(t,e,s)=>{var n={"./sound01.wav":5372,"./sound02.wav":2604,"./sound03.wav":9387,"./sound04.wav":8111,"./sound05.wav":7193,"./sound06.wav":3617,"./sound07.wav":5684,"./sound08.wav":9758,"./sound09.wav":5980,"./sound10.wav":4730,"./sound11.wav":3311,"./sound12.wav":726,"./sound13.wav":6833,"./sound14.wav":8784,"./sound15.wav":1329,"./sound16.wav":9512,"./sound17.wav":5640,"./sound18.wav":9493,"./sound19.wav":75,"./sound20.wav":4451,"./sound21.wav":651,"./sound22.wav":8899,"./sound23.wav":3682,"./sound24.wav":9399,"./sound25.wav":5292,"./sound26.wav":4323,"./sound27.wav":549,"./sound28.wav":3178,"./sound29.wav":4813};function o(t){var e=i(t);return s(e)}function i(t){if(!s.o(n,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return n[t]}o.keys=function(){return Object.keys(n)},o.resolve=i,t.exports=o,o.id=7518},2578:(t,e,s)=>{"use strict";t.exports=s.p+"image/G_Clef.png"},9410:(t,e,s)=>{"use strict";t.exports=s.p+"image/Mario.png"},3236:(t,e,s)=>{"use strict";t.exports=s.p+"image/about.png"},7997:(t,e,s)=>{"use strict";t.exports=s.p+"image/beat_button.png"},7712:(t,e,s)=>{"use strict";t.exports=s.p+"image/bomb.png"},7246:(t,e,s)=>{"use strict";t.exports=s.p+"image/character_sheet.png"},9179:(t,e,s)=>{"use strict";t.exports=s.p+"image/clear_button.png"},3295:(t,e,s)=>{"use strict";t.exports=s.p+"image/end_mark.png"},1413:(t,e,s)=>{"use strict";t.exports=s.p+"image/loading_transparent_.gif"},6206:(t,e,s)=>{"use strict";t.exports=s.p+"image/mario_sweat.png"},9113:(t,e,s)=>{"use strict";t.exports=s.p+"image/mat.png"},3944:(t,e,s)=>{"use strict";t.exports=s.p+"image/numbers.png"},9890:(t,e,s)=>{"use strict";t.exports=s.p+"image/play_button.png"},2788:(t,e,s)=>{"use strict";t.exports=s.p+"image/repeat_head.png"},6244:(t,e,s)=>{"use strict";t.exports=s.p+"image/semitone.png"},540:(t,e,s)=>{"use strict";t.exports=s.p+"image/share.png"},9513:(t,e,s)=>{"use strict";t.exports=s.p+"image/slider_thumb.png"},1719:(t,e,s)=>{"use strict";t.exports=s.p+"image/song_buttons.png"},8032:(t,e,s)=>{"use strict";t.exports=s.p+"image/stop_button.png"},3443:(t,e,s)=>{"use strict";t.exports=s.p+"image/undo_dog.png"},5372:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound01.wav"},2604:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound02.wav"},9387:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound03.wav"},8111:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound04.wav"},7193:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound05.wav"},3617:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound06.wav"},5684:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound07.wav"},9758:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound08.wav"},5980:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound09.wav"},4730:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound10.wav"},3311:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound11.wav"},726:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound12.wav"},6833:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound13.wav"},8784:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound14.wav"},1329:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound15.wav"},9512:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound16.wav"},5640:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound17.wav"},9493:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound18.wav"},75:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound19.wav"},4451:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound20.wav"},651:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound21.wav"},8899:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound22.wav"},3682:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound23.wav"},9399:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound24.wav"},5292:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound25.wav"},4323:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound26.wav"},549:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound27.wav"},3178:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound28.wav"},4813:(t,e,s)=>{"use strict";t.exports=s.p+"wav/sound29.wav"}},i={};function r(t){var e=i[t];if(void 0!==e)return e.exports;var s=i[t]={exports:{}};return o[t](s,s.exports,r),s.exports}r.m=o,e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,r.t=function(s,n){if(1&n&&(s=this(s)),8&n)return s;if("object"==typeof s&&s){if(4&n&&s.__esModule)return s;if(16&n&&"function"==typeof s.then)return s}var o=Object.create(null);r.r(o);var i={};t=t||[null,e({}),e([]),e(e)];for(var a=2&n&&s;"object"==typeof a&&!~t.indexOf(a);a=e(a))Object.getOwnPropertyNames(a).forEach((t=>i[t]=()=>s[t]));return i.default=()=>s,r.d(o,i),o},r.d=(t,e)=>{for(var s in e)r.o(e,s)&&!r.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,s)=>(r.f[s](t,e),e)),[])),r.u=t=>t+".bundle.js",r.miniCssF=t=>{},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s={},n="mariosequencer:",r.l=(t,e,o,i)=>{if(s[t])s[t].push(e);else{var a,c;if(void 0!==o)for(var u=document.getElementsByTagName("script"),d=0;d<u.length;d++){var l=u[d];if(l.getAttribute("src")==t||l.getAttribute("data-webpack")==n+o){a=l;break}}a||(c=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.setAttribute("data-webpack",n+o),a.src=t),s[t]=[e];var p=(e,n)=>{a.onerror=a.onload=null,clearTimeout(h);var o=s[t];if(delete s[t],a.parentNode&&a.parentNode.removeChild(a),o&&o.forEach((t=>t(n))),e)return e(n)},h=setTimeout(p.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=p.bind(null,a.onerror),a.onload=p.bind(null,a.onload),c&&document.head.appendChild(a)}},r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.p="",(()=>{var t={179:0};r.f.j=(e,s)=>{var n=r.o(t,e)?t[e]:void 0;if(0!==n)if(n)s.push(n[2]);else{var o=new Promise(((s,o)=>n=t[e]=[s,o]));s.push(n[2]=o);var i=r.p+r.u(e),a=new Error;r.l(i,(s=>{if(r.o(t,e)&&(0!==(n=t[e])&&(t[e]=void 0),n)){var o=s&&("load"===s.type?"missing":s.type),i=s&&s.target&&s.target.src;a.message="Loading chunk "+e+" failed.\n("+o+": "+i+")",a.name="ChunkLoadError",a.type=o,a.request=i,n[1](a)}}),"chunk-"+e,e)}};var e=(e,s)=>{var n,o,[i,a,c]=s,u=0;if(i.some((e=>0!==t[e]))){for(n in a)r.o(a,n)&&(r.m[n]=a[n]);c&&c(r)}for(e&&e(s);u<i.length;u++)o=i[u],r.o(t,o)&&t[o]&&t[o][0](),t[o]=0},s=self.webpackChunkmariosequencer=self.webpackChunkmariosequencer||[];s.forEach(e.bind(null,0)),s.push=e.bind(null,s.push.bind(s))})(),(()=>{"use strict";var t;!function(t){t[t.Edit=0]="Edit",t[t.MarioEntering=1]="MarioEntering",t[t.Playing=2]="Playing",t[t.MarioLeaving=3]="MarioLeaving"}(t||(t={}));class e{constructor(t,e,s){this.image=null,this.app=t,this.AC=t.AC,this.path=s,this.buffer=null,this.prevChord=[],this.diff=[14,12,11,9,7,6,4,2,0,-1,-3,-5,-6],this.settings=e}play(t,e){var s=this.AC.createBufferSource(),n=15&t,o=this.diff[n];0!=(128&t)?o++:0!=(64&t)&&o--,null==e&&(e=0),s.buffer=this.buffer,s.playbackRate.value=Math.pow(this.settings.SEMITONERATIO,o),s.connect(this.AC.destination),this.app.MSDestination&&s.connect(this.app.MSDestination),s.start(e)}playChord(t,e){for(var s=0;s<this.prevChord.length;s++)this.prevChord[s].stop();for(this.prevChord=[],null==e&&(e=0),s=0;s<t.length;s++){var n=this.AC.createBufferSource(),o=15&t[s],i=this.diff[o];0!=(128&t[s])?i++:0!=(64&t[s])&&i--,n.buffer=this.buffer,n.playbackRate.value=Math.pow(this.settings.SEMITONERATIO,i),n.connect(this.AC.destination),this.app.MSDestination&&n.connect(this.app.MSDestination),n.start(e),this.prevChord.push(n)}}load(){var t=this.path;return new Promise(((e,s)=>{var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=()=>{this.AC.decodeAudioData(n.response,(function(n){n||s("error decoding file data: "+t),e(n)}),(function(t){s("decodeAudioData error:"+t)}))},n.onerror=function(){s("BufferLoader: XHR error")},n.send()}))}}class s{constructor(t){this._sequencer=t}loadSounds(){return t=this,s=void 0,o=function*(){const t=this._sequencer,s=t.ASSETS.SOUNDS;for(let n=1;n<21;n++){let o="0";o+=n.toString();const i="wav/sound"+o.slice(-2)+".wav",r=new e(this._sequencer,t.CONST,i);s[n-1]=r}yield Promise.all(t.ASSETS.SOUNDS.map((t=>t.load()))).then((e=>{e.map(((e,s)=>{t.ASSETS.SOUNDS[s].buffer=e}))}))},new((n=void 0)||(n=Promise))((function(e,i){function r(t){try{c(o.next(t))}catch(t){i(t)}}function a(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(t){t(s)}))).then(r,a)}c((o=o.apply(t,s||[])).next())}));var t,s,n,o}}const n=class{constructor(t,e,s){this._lastTime=0,this.switch=!1,this.currentFrame=0,this.images=[],this._frequency=t,this._func=e,s&&(this.images=s)}checkAndFire(t){this.switch&&t-this._lastTime>this._frequency&&(this._func(),this._lastTime=t)}};class o{constructor(t){this.offset=-16,this.scroll=0,this.x=-16,this.sweatImage=null,this.spriteImages=null,this.pos=0,this.start=0,this.state=0,this.switch=!0,this.isJumping=!1,this.lastTime=0,this.sequencer=t,t.ASSETS.IMAGES&&(this.spriteImages=t.ASSETS.IMAGES.Mario,this.sweatImage=t.ASSETS.IMAGES.Sweat),this.init()}init(){this.x=-16,this.pos=0,this.start=0,this.state=0,this.scroll=0,this.offset=-16;const t=this.mario=this;this.timer=new n(100,(function(){t.state=1==t.state?0:1})),this.timer.switch=!0,this.isJumping=!1}enter(t){0==this.start&&(this.start=t);const e=t-this.start;this.x=Math.floor(e/5)+this.offset,this.x>=40&&(this.x=40),Math.floor(e/100)%2==0?this.state=1:this.state=0,this.draw()}init4leaving(){this.offset=this.x,this.start=0,this.isJumping=!1}init4playing(t){this.lastTime=t,this.offset=this.x,this.scroll=0,this.pos=1,this.state,this._checkMarioShouldJump()}_checkMarioShouldJump(){const t=this.sequencer.appState.curScore.notes[this.pos-1];null==t||0==t.length?this.isJumping=!1:1==t.length?this.isJumping="string"!=typeof t[0]:this.isJumping=!0}play(t){var e;const{sequencer:s}=this,n=s.appState.curScore.tempo;if(this.mario){let i=t-this.lastTime;i>32&&(i=16),this.lastTime=t;const r=32*i*n/6e4;null===(e=this.timer)||void 0===e||e.checkAndFire(t);const a=document.getElementById("scroll");var o=16+32*(this.pos-s.appState.curPos+1)-8;this.mario.x<120?(this.x+=r,this.x>=o?(this.pos++,s.scheduleAndPlay(s.appState.curScore.notes[this.pos-2],0),this._checkMarioShouldJump()):this.x>=120&&(this.scroll=this.x-120,this.x=120)):s.appState.curPos<=s.appState.curScore.end-6?(this.x=120,this.scroll<16&&this.scroll+r>16?(this.pos++,this.scroll+=r,s.scheduleAndPlay(s.appState.curScore.notes[this.pos-2],0),this._checkMarioShouldJump()):(this.scroll+=r,this.scroll>32&&(this.scroll-=32,s.appState.curPos++,a&&(a.value=s.appState.curPos.toString()),s.appState.curPos>s.appState.curScore.end-6&&(this.x+=this.scroll,this.scroll=0)))):(this.x+=r,this.x>=o&&(this.pos++,s.scheduleAndPlay(s.appState.curScore.notes[this.pos-2],0),this._checkMarioShouldJump())),s.drawScore(s.appState.curPos,s.appState.curScore.notes,this.scroll),this.draw()}}_jump(t){return[0,2,4,6,8,10,12,13,14,15,16,17,18,18,19,19,19,19,19,18,18,17,16,15,14,13,12,10,8,6,4,2,0][Math.round(t)%32]}draw(){if(this.spriteImages){let t=19,e=this.state;this.isJumping&&(e=2,120==this.x?16!=this.scroll&&(t-=this._jump(this.scroll>16?this.scroll-16:this.scroll+16)):t-=this._jump(Math.round((this.x-8)%32))),this.sequencer.drawMario(this.spriteImages[e],this.x,t)}}leave(t){if(this.sweatImage){0==this.start&&(this.start=t);const e=t-this.start;if(this.scroll>0&&this.scroll<32?(this.scroll+=Math.floor(e/4),this.scroll>32&&(this.x+=this.scroll-32,this.scroll=0,this.sequencer.appState.curPos++)):this.x=Math.floor(e/4)+this.offset,Math.floor(e/100)%2==0){this.state=8,this.draw();const t=this.sweatImage.width,e=this.sweatImage.height;this.sequencer.drawMarioSweat(this.sweatImage,0,0,t,e,this.x-(t+1),19,t,e)}else this.state=9,this.draw()}}}const i=[];i[0]={notes:[[1026,2313],[1026,2313],[],[1026,2313],[],[1028,2315],[1026,2313],[],[1024,2311],[],[],[],[517,3591,265],[],[],[],[2818,2820,267],[],[3072,3595],[3072,2818,3595],[2817,2820,267],[],[3072,3592],[3072,2817,3591],[2816,2819,267],[],[3072,3591],[2816,1287,3595],[2817,1286,1288],[262,1288,1290],[1286,3591,1288],[1285,1287,266],[2,3595,3084],[],[256],[257,3595],[4,3593,3084],[],[256],[257,7,3593],[6,3592,3084],[4],[256,3592],[257,4,3590],[3084],[256],[],[257,6,3591],[7,3084],[3591],[256,4,3592],[257],[4,3593,3084],[],[0,3594],[257],[2,3591],[1031],[256,1030],[3,1029,3592],[1028],[1027,262],[1026],[1025,263],[1026,266,3595],[7],[2050,4],[7,266,3595],[1028,3593,266],[7],[2050,4],[5,1031,3593],[1030,3592,266],[1028,6,2568],[4],[1,1028,3590],[264],[2049,2,260],[3,260],[261,1030],[1031,266],[3584,2,7],[1028],[1,5,7],[1025,3591],[1026],[1027],[],[1028],[258,3588],[],[260,3595],[261,3595],[],[261,267],[],[]],beats:4,loop:!1,end:96,tempo:"370"},i[1]={notes:[[772,779],[768],[770,779],[768],[772,775],[768],[770,775],[768],[772,774],[769],[772,774],[769],[768,770,775],[],[],[],[769,774,776],[772],[769,774,776],[772],[770,775,777],[772],[770,775,777],[772],[771,773,778],[775],[771,778],[773],[771,777,779],[],[],[],[775,777],[768],[775,777],[768],[776,778],[768],[776,778],[768],[777,779],[768],[777,779],[768],[778,780],[],[],[],[775],[768,772],[775],[768,772],[776],[768,772],[776],[768,772],[777],[768,772],[777],[768,772],[771,773,778],[],[],[],[777,779],[779],[777,779],[779],[775,777],[777],[775,777],[777],[774,776],[776],[774,776],[776],[768,775,777],[],[],[],[774,776],[776],[774,776],[773],[772,777],[775],[772,777],[],[771,775,778],[],[771,775,778],[],[772,777,779],[],[],[],[]],beats:4,loop:!0,end:96,tempo:"178"},i[2]={notes:[[266,3595],[3072,2,7],[3591,3081],[3072,2,7],[2305,3590,266],[2305,2,7],[1,2307,3594],[3078],[266,3595],[3072,2,7],[3591,3081],[3072,2,7],[2305,3590,266],[2305,3,7],[1,2307,3594],[],[1028,3079,3595],[3072,2,7],[1028,3078,3591],[1026,261,7],[1024,267],[],[1543],[],[1281,3594],[1,6],[1281,3590],[1282,6],[1283],[],[1798],[],[1027,3079,3594],[3072,1,6],[1027,3590,3082],[1025,261,6],[1030,267],[],[2055,2059],[],[1280,1285,3595],[2,7],[1280,1285,3591],[1281,2,1286],[1282,1287,266],[2571],[],[],[1287,779],[775],[1287,777],[772,1287],[1284,775,264],[2306,3077],[2306,264],[2308,3077],[1286,2826],[2822],[1286,2824],[2819,1286],[1284,2822,264],[2305,3077],[2305,264],[2307,3077],[1285,3335,264],[3331],[1285,3335],[3329,1285],[1283,1029,264],[],[519],[],[2304,1282,1028],[2304,1282,1028],[2304,1282,1028],[2305,1283,1029],[2306,1284,1030],[],[2304,1282,1028],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],beats:4,loop:!0,end:80,tempo:"287"};const a=i;function c(t,e=!1){const s=new Event("click");s.soundOff=!0,t.dispatchEvent(s)}var u;!function(t){t.boundFn=function(t,e){return e.bind(t)},t.getConstants=function(e,s){const n=e.mag||e.magnify||t.getScaledMagnify(),o=16*n,i=Math.floor(o/2);return s.style.width=256*n+"px",s.style.height=224*n+"px",{CHARSIZE:o,DEFAULTMAXBARS:97,DEFAULTTEMPO:100,HALFCHARSIZE:i,MAGNIFY:n,ORGHEIGHT:224,ORGWIDTH:256,SCRHEIGHT:152,SEMITONERATIO:Math.pow(2,1/12),OFFSETLEFT:s.offsetLeft,OFFSETTOP:s.offsetTop}},t.getScaledMagnify=function(){const t=Math.floor(window.innerWidth/256),e=Math.floor((window.innerHeight-84)/224);return Math.min(t,e)},t.createButton=function(t){const{h:e,id:s,images:n,w:o,x:i,y:r,className:a,clickHandler:c}=t,u=document.createElement("button");return u.id=s,u.className="game",u.style.position="absolute",this.moveDOM(u,i,r),this.resizeDOM(u,o,e),u.style.zIndex="3",u.style.background="rgba(0,0,0,0)",u.originalX=i,u.originalY=r,u.originalW=o,u.originalH=e,u.setCurrentFrame=function(t){this.currentFrame=this.images[t],this.style.backgroundImage="url("+this.currentFrame.src+")"},u.redraw=()=>{this.moveDOM(u,u.originalX,u.originalY),this.resizeDOM(u,u.originalW,u.originalH),u.currentFrame&&(u.style.backgroundImage="url("+u.currentFrame.src+")")},n&&(u.images=n),c&&u.addEventListener("click",c),a&&u.classList.add(a),u},t.createChoiceGroupFunction=function(t,e,s){const n=this,o=t.slice(0),i=o[e];o.splice(e,1);const r=o;return function(t){t.soundOff||n.ASSETS.SOUNDS[17].play(8),this.disabled=!0,this.setCurrentFrame(1),r.map((function(t){t.disabled=!1,t.setCurrentFrame(0)})),s(i)}},t.showSpriteFrame=function(t,e){return function(s){return new Promise((function(n,o){setTimeout((function(){t.style.backgroundImage="url("+t.images[s].src+")",n()}),e)}))}},t.getImageElFromPath=function(t){return e=this,s=void 0,o=function*(){return new Promise(((e,s)=>{const n=new Image;n.src=t,n.onload=()=>{e(n)},n.onerror=()=>{}}))},new((n=void 0)||(n=Promise))((function(t,i){function r(t){try{c(o.next(t))}catch(t){i(t)}}function a(t){try{c(o.throw(t))}catch(t){i(t)}}function c(e){var s;e.done?t(e.value):(s=e.value,s instanceof n?s:new n((function(t){t(s)}))).then(r,a)}c((o=o.apply(e,s||[])).next())}));var e,s,n,o},t.sliceImage=function(t,e,s){const{MAGNIFY:n}=this.CONST,o=[],i=(t.width,t.height,Math.floor(t.width/e)),r=i*Math.floor(t.height/s),a=e*n,c=s*n;for(let n=0;n<r;n++){const r=document.createElement("canvas");r.width=a,r.height=c;const u=r.getContext("2d");u&&(u.imageSmoothingEnabled=!1,u.drawImage(t,n%i*e,Math.floor(n/i)*s,e,s,0,0,a,c));const d=new Image;d.src=r.toDataURL(),o[n]=d}return o},t.clone=function(t){return JSON.parse(JSON.stringify(t))}}(u||(u={}));const d=u,l="yTFHQm16Fu2lo5Sqs8iT",p="xTtMW1Psn0SPsihvnKfH",h="OJAprIY_G5RLJjvhPUak",S="WdRzIhUquDXwXynqFgA6";var m,g=function(t,e,s,n){return new(s||(s=Promise))((function(o,i){function r(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}c((n=n.apply(t,e||[])).next())}))};!function(e){e.Loader=class{constructor(t){this._sequencer=t,this._onMouse=this._onMouse.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._sliceImage=d.boundFn(t,d.sliceImage),this._createButton=d.createButton.bind(t),this._createChoiceGroupFunction=d.createChoiceGroupFunction.bind(t)}init(t){return g(this,void 0,void 0,(function*(){yield this._initLayers(),yield this._initImageAssets(t),this._initBomb(),this._initInstrumentButtons(),this._initEndMarkButton(),this._initPlayButton(),this._initStopButton(),this._initLoopButton(),this._initScrollRange(),this._initBeatButtons(),this._initSongButtons(),this._initUndoDog(),this._initEraserButton(),this._initTempoRange(),this._initClearButton(),this._sequencer.mario=new o(this._sequencer),t||(this._sequencer.initMusicScore(),this._initScreen(),this._initKeyboardEventListeners(),this._initMouseEvents())}))}_initLayers(){return g(this,void 0,void 0,(function*(){const t=this._sequencer,{MAGNIFY:e,ORGHEIGHT:s,ORGWIDTH:n,SCRHEIGHT:o}=t.CONST,i=d.getImageElFromPath;let r=document.querySelector("#layer1"),a=document.querySelector("#layer2");r||(r=document.createElement("canvas"),r.id="layer1",r.classList.add("game"),t.container.appendChild(r)),t.Layer1=r,a||(a=document.createElement("canvas"),a.id="layer2",a.classList.add("game"),t.container.appendChild(r)),t.Layer2=a,t.L1C=t.Layer1.getContext("2d"),t.L2C=t.Layer2.getContext("2d"),t.Layer1.width=n*e,t.Layer1.height=s*e,t.Layer2.width=n*e,t.Layer2.height=o*e,t.L1C&&(t.L1C.imageSmoothingEnabled=!1),t.L2C&&(t.L2C.imageSmoothingEnabled=!1);const c=yield i("image/mat.png");t.L1C&&t.L1C.drawImage(c,0,0,c.width*e,c.height*e)}))}_loadSpritesheets(){return g(this,void 0,void 0,(function*(){const t=this._sequencer,e=d.getImageElFromPath,s=yield e("image/character_sheet.png"),n=yield e("image/bomb.png"),o=yield e("image/end_mark.png"),i=yield e("image/play_button.png"),r=yield e("image/repeat_head.png"),a=yield e("image/semitone.png"),c=yield e("image/numbers.png"),u=yield e("image/stop_button.png"),l=yield e("image/beat_button.png"),p=yield e("image/song_buttons.png"),h=yield e("image/slider_thumb.png"),S=yield e("image/clear_button.png"),m=yield e("image/Mario.png"),g=yield e("image/undo_dog.png");t.ASSETS.SPRITESHEETS={Chars:s,Bomb:n,End:o,PlayBtn:i,Repeat:r,Semitone:a,Numbers:c,Stop:u,Beat:l,Song:p,ThumbSlider:h,ClearBtn:S,Mario:m,UndoDog:g}}))}_initImageAssets(t){return g(this,void 0,void 0,(function*(){const e=this._sequencer;t||(yield this._loadSpritesheets());const{SPRITESHEETS:s}=e.ASSETS,n=d.getImageElFromPath;if(s){const t=this._sliceImage(s.Repeat,13,62);e.ASSETS.IMAGES={Tools:this._sliceImage(s.Chars,16,16),Bomb:this._sliceImage(s.Bomb,14,18),GClef:yield n("image/G_Clef.png"),Numbers:this._sliceImage(s.Numbers,5,7),Mario:this._sliceImage(s.Mario,16,22),Sweat:yield n("image/mario_sweat.png"),PlayBtn:this._sliceImage(s.PlayBtn,12,15),StopBtn:this._sliceImage(s.Stop,16,15),ClearBtn:this._sliceImage(s.ClearBtn,34,16),ThumbSlider:this._sliceImage(s.ThumbSlider,5,8),BeatBtn:this._sliceImage(s.Beat,14,15),SongBtns:this._sliceImage(s.Song,15,17),EndMarkBtn:this._sliceImage(s.End,14,13),EndMark:t[2],Semitone:this._sliceImage(s.Semitone,5,12),Repeat:t,UndoDog:this._sliceImage(s.UndoDog,14,15)}}}))}_initBomb(){const e=this._sequencer,{MAGNIFY:s}=e.CONST,{IMAGES:o}=e.ASSETS;o&&e.L1C&&(e.TIMERS.bomb=new n(150,(function(){const n=9*s,i=202*s,r=o.Bomb[this.currentFrame];switch(e.L1C&&e.L1C.drawImage(r,n,i),this.currentFrame){case 0:this.currentFrame=1;break;case 1:this.currentFrame=0}null!=e.appState.selectedSongBtn&&e.appState.gameStatus==t.Playing&&(e.appState.selectedSongBtn.style.backgroundImage="url("+e.appState.selectedSongBtn.images[this.currentFrame+1].src+")")})),e.TIMERS.bomb.switch=!0,e.TIMERS.bomb.currentFrame=0)}_initInstrumentButtons(){const t=this._sequencer,e=this,{BUTTONS:s,SOUNDS:n,IMAGES:o}=t.ASSETS;if(o){const i=o.Tools;for(let o=0;o<15;o++){const r=this._getOrCreateButton(24+14*o,8,13,14,"instr_"+o,[i[o]],(()=>{r.se.play(8),t.setState({currentTool:r.num}),e._clearEraserButton(),e.changeCursor(r.num),r.se.image&&e._drawCurChar(r.se.image)}));r.num=o,r.se=n[o],r.se.image=i[o],s[o]=r}}}_initEndMarkButton(){const t=this._sequencer,e=this,{MAGNIFY:s}=t.CONST,{IMAGES:o}=t.ASSETS;if(o){const i=this._getOrCreateButton(235,8,13,14,"endmark",o.EndMarkBtn,(()=>{t.TIMERS.endMark.switch=!0,t.setState({currentTool:15}),t.ASSETS.SOUNDS[15].play(8),e._clearEraserButton(),t.drawEndMarkIcon(i.images[0])}));i.images=o.EndMarkBtn,t.TIMERS.endMark=new n(150,(function(){15==t.appState.currentTool?(this.currentFrame=0==this.currentFrame?1:0,t.Layer2&&(t.Layer2.style.cursor="url("+this.images[this.currentFrame].src+")"+7*s+" "+7*s+", auto")):this.switch=!1}),i.images),t.ASSETS.BUTTONS[15]=i}}_initPlayButton(){const t=this._sequencer,{IMAGES:e}=t.ASSETS;e&&this._getOrCreateButton(55,168,12,15,"play",e.PlayBtn,(function(t){const e=new Event("playsong",{bubbles:!0});this.dispatchEvent(e)}),"U1meHdgWpOA9vU0jbtcL").setCurrentFrame(0)}_initStopButton(){const t=this._sequencer,{IMAGES:e}=t.ASSETS;if(e){const t=e.StopBtn,s=this._getOrCreateButton(21,168,16,15,"stop",[t[0],t[1]],(function(t){const e=new Event("stopsong",{bubbles:!0});this.dispatchEvent(e)}),"WYUvtHzL8HX_XQ4oiY2Y");s.disabled=!1,s.setCurrentFrame(1)}}_initLoopButton(){const t=this._sequencer,{appState:e}=t,{IMAGES:s}=t.ASSETS;if(s){const n=s.StopBtn,o=this._getOrCreateButton(85,168,16,15,"loop",[n[2],n[3]],(function(s){let n=!0;t.appState.curScore.loop&&(n=!1);let o=n?1:0;t.setState(Object.assign(Object.assign({},e),{curScore:Object.assign(Object.assign({},e.curScore),{loop:n})})),this.setCurrentFrame(o),t.ASSETS.SOUNDS[17].play(8)}),"XSIBXVxmBvgSDfKqWxdD");o.setCurrentFrame(0),t.appState.curScore.loop=!1,o.reset=function(){t.appState.curScore.loop=!1,this.setCurrentFrame(0)},o.set=function(){t.appState.curScore.loop=!0,this.setCurrentFrame(1)}}}_initScrollRange(){const t=this._sequencer,{MAGNIFY:e}=t.CONST;let s=document.getElementById("scroll");null===s&&(s=document.createElement("input"),s.id="scroll",s.classList.add("Cnz701ioK7oELYepSZwB"),s.type="range",s.value="0",s.max=(t.curMaxBars-6).toString(),s.min="0",s.step="0.2",s.style["-webkit-appearance"]="none",s.style["border-radius"]="0px",s.style["background-color"]="#F8F8F8",s.style["box-shadow"]="inset 0 0 0 #000",s.style["vertical-align"]="middle",s.style.position="absolute",s.style.margin="0",s.originalX=191,s.originalY=159,s.originalW=50,s.originalH=7,t.moveDOM(s,s.originalX,s.originalY),t.resizeDOM(s,s.originalW,s.originalH),s.redraw=()=>{t.moveDOM(s,s.originalX,s.originalY),t.resizeDOM(s,s.originalW,s.originalH)},s.addEventListener("input",(function(e){t.appState.curPos=parseInt(this.value)})),t.Layer2&&t.Layer2.addEventListener("wheel",(t=>{t.deltaY<0?s.valueAsNumber+=.2:s.valueAsNumber-=.2;let e=new Event("input",{bubbles:!0,cancelable:!0});s.dispatchEvent(e),t.preventDefault(),t.stopPropagation()})),t.container.appendChild(s))}_initBeatButtons(){const t=this._sequencer,{IMAGES:e}=(this._createChoiceGroupFunction.bind(t),t.ASSETS);if(e){const s=e.BeatBtn,n=this._getOrCreateButton(81,203,14,15,"3beats",[s[0],s[1]]);n.beats=3,n.setCurrentFrame(0),n.disabled=!1;const o=this._getOrCreateButton(96,203,14,15,"4beats",[s[2],s[3]]);o.beats=4,o.setCurrentFrame(1),o.disabled=!0;const i=function(e){const{appState:s}=t;t.setState(Object.assign(Object.assign({},s),{curScore:Object.assign(Object.assign({},s.curScore),{beats:e.beats})}))};o.addEventListener("click",this._createChoiceGroupFunction([n,o],1,i)),n.addEventListener("click",this._createChoiceGroupFunction([n,o],0,i))}}_initSongButtons(){const t=this._sequencer,e=this,{IMAGES:s}=t.ASSETS;if(s){const n=s.SongBtns,o=["frog","beak","1up"].map((function(t,s){const o=e._getOrCreateButton(136+24*s,202,15,17,t,n.slice(3*s,3*s+3));return o.id=t,o.num=s,o.setCurrentFrame(0),o.disabled=!1,o})),i=function(e){const{appState:s}=t,n=d.clone(a[e.num]),o=document.getElementById("tempo");o&&(o.value=n.tempo.toString());const i=document.getElementById("loop");n.loop?i.set():i.reset();const r=document.getElementById("scroll");r.max=(n.end-5).toString(),r.value="0",t.setState({curScore:n,curPos:0,selectedSongBtn:e}),t.drawScore(t.appState.curPos,t.appState.curScore.notes,0)};o.forEach(((t,e)=>{o[e].addEventListener("click",this._createChoiceGroupFunction(o,e,i))}))}}_initUndoDog(){const e=this._sequencer,s=this,{IMAGES:n}=e.ASSETS;n&&this._getOrCreateButton(216,203,14,15,"undoDog",n.UndoDog,(function(){return g(this,void 0,void 0,(function*(){if(e.appState.gameStatus===t.Edit){e.ASSETS.SOUNDS[18].play(8);const t=d.showSpriteFrame(this,150);yield t(1),yield t(0);const n=e.appState.history.pop();let o=n&&e.appState.currentTool!==n.currentTool,i=n&&n.selectedSongBtn!==e.appState.selectedSongBtn,r=n&&n.curScore.beats!==e.appState.curScore.beats;n&&(e.appState=n),o&&s.changeCursor(e.appState.currentTool),i&&(["frog","beak","1up"].forEach((function(t,e){const s=document.getElementById(t);s.setCurrentFrame(0),s.disabled=!1})),e.appState.selectedSongBtn&&(e.appState.selectedSongBtn.setCurrentFrame(1),e.appState.selectedSongBtn.disabled=!0)),r&&["3beats","4beats"].forEach((function(t,s){const n=document.getElementById(t),o=n.beats===e.appState.curScore.beats;n.setCurrentFrame(o?1:0),n.disabled=o})),e.drawScore(e.appState.curPos,e.appState.curScore.notes,e.appState.curPos)}}))})).setCurrentFrame(0)}_initEraserButton(){const t=this._sequencer,e=this,{IMAGES:s}=t.ASSETS;if(s){const o=s.SongBtns;this._getOrCreateButton(40,202,15,17,"eraser",[o[9],o[10],o[11]],(function(){t.TIMERS.eraser.switch=!0,t.setState({currentTool:16}),t.ASSETS.SOUNDS[17].play(8),t.drawEraserIcon(),e._clearSongButtons(),this.setCurrentFrame(1),t.Layer2&&(t.Layer2.style.cursor="url("+this.images[2].src+") 0 0, auto")})).setCurrentFrame(0),t.TIMERS.eraser=new n(200,(function(){16==t.appState.currentTool?this.currentFrame=0==this.currentFrame?1:0:this.switch=!1})),t.TIMERS.eraser.currentFrame=0}}_initTempoRange(){const t=this._sequencer,{IMAGES:e}=t.ASSETS;if(e){const s=t=>{const s=e.ThumbSlider[0];t.image=s;const n=document.querySelector(`.${l}`);n&&n.style.setProperty("--tempoThumbImg",`url('${s.src}')`)};let n=document.getElementById("tempo");null===n&&(n=document.createElement("input"),n.id="tempo",n.classList.add("keKt_gNCI4vGK7c9kCAx"),n.type="range",n.value="525",n.max="1000",n.min="50",n.step="1",n.style["-webkit-appearance"]="none",n.style["border-radius"]="0px",n.style["background-color"]="rgba(0, 0, 0, 0.0)",n.style["box-shadow"]="inset 0 0 0 #000",n.style["vertical-align"]="middle",n.style.position="absolute",n.style.margin="0",n.originalX=116,n.originalY=172,n.originalW=40,n.originalH=8,t.moveDOM(n,n.originalX,n.originalY),t.resizeDOM(n,n.originalW,n.originalH),n.redraw=()=>{t.moveDOM(n,n.originalX,n.originalY),t.resizeDOM(n,n.originalW,n.originalH),s(n)},n.addEventListener("input",(function(e){t.appState.curScore.tempo=parseInt(this.value)})),n.addEventListener("mouseup",(function(e){const{appState:s}=t;t.setState({curScore:Object.assign(Object.assign({},s.curScore),{tempo:parseInt(this.value)})})})),t.container.appendChild(n),s(n)),this._getOrCreateButton(184,158,7,9,"toLeft",[],(function(e){const s=document.getElementById("scroll");let n=parseInt(s.value,10);n>0&&(t.appState.curPos=--n)})),this._getOrCreateButton(241,158,7,9,"toRight",[],(function(e){const s=document.getElementById("scroll");let n=parseInt(s.value,10);n<t.curMaxBars-6&&(t.appState.curPos=++n)}))}}_initClearButton(){const t=this._sequencer,e=this,{IMAGES:s}=t.ASSETS;s&&this._getOrCreateButton(200,176,34,16,"clear",s.ClearBtn,(function(s){return g(this,void 0,void 0,(function*(){this.style.backgroundImage="url("+this.images[1].src+")",t.ASSETS.SOUNDS[19].play(8);const s=d.showSpriteFrame(this,150);yield s(2),yield s(1),yield s(0),t.initMusicScore(),t.appState.curPos=0,e._clearSongButtons()}))}),"NttrDqMWvGKnDDI88W9B").setCurrentFrame(0)}_reInitButtonsFromScore(){const t=this._sequencer;c(document.getElementById(3==t.appState.curScore.beats?"3beats":"4beats"),!0);const e=document.getElementById("scroll");t.curMaxBars=t.appState.curScore.end+1,e.max=(t.curMaxBars-6).toString(),e.value="0",t.appState.curPos=0;const s=document.getElementById("tempo");let n=t.appState.curScore.notes[0][0];"string"==typeof n&&"TEMPO"==n.substr(0,5)&&(n=n.split("=")[1],t.appState.curScore.tempo=n,s.value=n)}_initScreen(){const t=this._sequencer,{SOUNDS:e}=t.ASSETS;t.appState.curPos=0,t.appState.currentTool=0;const s=e[t.appState.currentTool].image;s&&this._drawCurChar(s),this.changeCursor(t.appState.currentTool),t.drawScore(t.appState.curPos,t.appState.curScore.notes,0),window.requestAnimFrame(t.doAnimation)}_initMouseEvents(){const t=this._sequencer;t.Layer2&&(t.Layer2.addEventListener("contextmenu",this._onMouse),t.Layer2.addEventListener("click",this._onMouse),t.Layer2.addEventListener("mousemove",this._onMouseMove),t.Layer2.addEventListener("dragover",(t=>(t.preventDefault(),!1))),t.Layer2.addEventListener("drop",this._readDroppedFiles))}changeCursor(t){const e=this._sequencer,{HALFCHARSIZE:s}=e.CONST,{SOUNDS:n}=e.ASSETS,o=e.Layer2,i=n[t].image;o&&i&&(o.style.cursor="url("+i.src+")"+s+" "+s+", auto")}_drawCurChar(t){const e=this._sequencer,{CHARSIZE:s,MAGNIFY:n}=e.CONST,o=4*n,i=7*n;e.L1C&&(e.L1C.beginPath(),e.L1C.imageSmoothingEnabled=!1,e.L1C.clearRect(o,i,s,s),e.L1C.drawImage(t,o,i),e.L1C.fillRect(o,i,s,n),e.L1C.fillRect(o,i+s-n,s,n))}_clearEraserButton(){const t=this._sequencer,e=document.getElementById("eraser");e.style.backgroundImage="url("+e.images[0].src+")",t.TIMERS.eraser.switch=!1}_clearSongButtons(){const t=this._sequencer;["frog","beak","1up"].map((function(t,e){const s=document.getElementById(t);s.disabled=!1,s.style.backgroundImage="url("+s.images[0].src+")"})),t.appState.selectedSongBtn=void 0}_onMouse(e){var s;const n=this._sequencer;if(e.preventDefault(),"contextmenu"===e.type)return void(null===(s=document.getElementById("undoDog"))||void 0===s||s.click());const{OFFSETLEFT:o,OFFSETTOP:i}=n.CONST,{SOUNDS:r}=n.ASSETS;if(n.appState.gameStatus!=t.Edit)return;const a=e.clientX-o,c=e.clientY-i,u=this.toGrid(a,c);if(0==u)return;const d=u[0];let l=u[1];const p=n.appState.curPos+d-2;if(15==n.appState.currentTool)return n.updateHistory(),void(n.appState.curScore.end=p);if(p>=n.appState.curScore.end)return;const h=[...n.appState.curScore.notes],S=[...h[p]];if(16==n.appState.currentTool||2==e.button){n.updateHistory();for(let t=S.length-1;t>=0;t--)if(S[t]==l){S.splice(t,1),n.appState.curScore.notes[p]=S,r[17].play(8);break}return}let m=n.appState.currentTool<<8|l;-1==S.indexOf(m)&&(e.shiftKey&&(l|=128),e.ctrlKey&&(l|=64),r[n.appState.currentTool].play(l),m=n.appState.currentTool<<8|l,S.push(m),h[p]=S,n.setState({curScore:Object.assign(Object.assign({},n.appState.curScore),{notes:h})}))}_onMouseMove(t){const e=this._sequencer;e.appState.mouseX=t.clientX,e.appState.mouseY=t.clientY}_readDroppedFiles(t){const e=this._sequencer;if(t.preventDefault(),this._clearSongButtons(),e.resetScore(),t.dataTransfer){var s=[].slice.call(t.dataTransfer.files);s.sort((function(t,e){var s=t.name,n=e.name;function o(t){let e=/\d+\.\d+|\d+/.exec(t);return null==e?0:e[0]?parseFloat(e[0]):0}return o(s)-o(n)})),s.map((function(t){return new Promise((function(e,s){var n=new FileReader;n.name=t.name,n.addEventListener("load",(function(t){e(t.target)})),n.readAsText(t,"shift-jis")}))})).reduce((function(t,s,n){return t.then((function(){return s})).then((function(t){t&&("msq"==t.name.slice(-3)?e.addMSQ(t.result):e.addJSON(t.result))})).catch((function(t){alert("Loading MSQ failed: "+t.message),console.error(t)}))}),Promise.resolve()).then(this._reInitButtonsFromScore)}return!1}_initKeyboardEventListeners(){const e=this._sequencer;document.addEventListener("keyup",(function(t){e.appState.keyPresses=e.appState.keyPresses.filter((e=>e!==t.key)),"r"==t.key&&e.canvasRecorder&&e.canvasRecorder.start(),"s"==t.key&&e.canvasRecorder&&(e.canvasRecorder.stop(),e.canvasRecorder.save("composer-song.webm"))})),document.addEventListener("keydown",(function(s){e.appState.keyPresses.indexOf(s.key)<0&&e.appState.keyPresses.push(s.key);const n=document.getElementById("play"),o=document.getElementById("stop"),i=document.getElementById("scroll");let r=!1;const a=e.appState.keyPresses.indexOf("Shift")>=0;switch(s.key){case" ":0==n.disabled||a?e.appState.gameStatus===t.Edit?n.click():a&&(e.appState.curPos=0,i.valueAsNumber=0,cancelAnimationFrame(e.appState.animeId),e.appState.animeId=window.requestAnimFrame(e.doMarioEnter)):o.click(),s.preventDefault();break;case"ArrowLeft":i.valueAsNumber-=a?1:.2,r=!0,s.preventDefault();break;case"ArrowRight":i.valueAsNumber+=a?1:.2,r=!0,s.preventDefault()}if(r){let t=new Event("input",{bubbles:!0,cancelable:!0});i.dispatchEvent(t)}}))}_getOrCreateButton(t,e,s,n,o,i,r,a){const c=this._sequencer;let u=document.getElementById(o);return null===u?(u=this._createButton({x:t,y:e,w:s,h:n,id:o,images:i,clickHandler:r,className:a}),c.container.appendChild(u)):u.images=i,u}toGrid(t,e){const s=this._sequencer,{CHARSIZE:n,HALFCHARSIZE:o,MAGNIFY:i}=s.CONST,r=8*i,a=41*i;if(t<r||t>243*i||e<a||e>144*i)return!1;let c=Math.floor((t-r)/n);if(c%2!=0)return!1;c/=2;const u=Math.floor((e-a)/o);return!(0==s.appState.curPos&&c<2||1==s.appState.curPos&&0==c)&&[c,u]}}}(m||(m={}));const f=m;var v=function(t,e,s,n){return new(s||(s=Promise))((function(o,i){function r(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}c((n=n.apply(t,e||[])).next())}))};function w(t,e,s,n,o,i){return v(this,void 0,void 0,(function*(){const{SOUNDS:r}=t.ASSETS,a=t=>(e,s,n,o)=>(t[parseInt(s,10)].forEach((t=>{e.indexOf(t)<0&&e.push(t)})),e),c=Object.keys(e).reduce(a(e),[]),u=Object.keys(s).reduce(a(s),[]);let d=!0;c.forEach((t=>{0===u.length&&(d=!1)}));const l=Object.keys(e).map((t=>parseInt(t,10)));let p=0;const h=l.reduce(((t,e,s,n)=>{const o=r[e].buffer;return o&&o.duration>p&&(p=o.duration),o&&!t[e]&&(t[e]=o),t}),{}),S=new OfflineAudioContext(2,44100*(d?n:p),44100);S.addEventListener("complete",(e=>{const s=new Event("mp3update");s.data={type:"chordGenUpdate",value:o/i},t.container.dispatchEvent(s)}));const m=S.destination,g=Math.pow(2,1/12),f=[14,12,11,9,7,6,4,2,0,-1,-3,-5,-6];return l.forEach((t=>{e[t].forEach((e=>{const s=S.createBufferSource();let n=f[15&e];0!=(128&e)?n++:0!=(64&e)&&n--,s.buffer=h[t],s.playbackRate.value=Math.pow(g,n),s.connect(m),s.start(0)}))})),yield S.startRendering()}))}function y(t){const e=new Int16Array(t.length);for(let s=0;s<t.length;s++){const n=32767*t[s];e[s]=n<0?n+65536:n}return e}function E(t){return new Promise((e=>v(this,void 0,void 0,(function*(){const s=new((yield r.e(644).then(r.t.bind(r,5644,19))).Mp3Encoder)(t.numberOfChannels,t.sampleRate,128),n=y(t.getChannelData(0)).length,o=1152,i=[];for(let e=0;e<n;e+=o){const n=y(t.getChannelData(0)).subarray(e,e+o),r=2===t.numberOfChannels?y(t.getChannelData(1)).subarray(e,e+o):n,a=s.encodeBuffer(n,r);a.length>0&&i.push(a)}const a=new Blob(i,{type:"audio/mp3"});e(a)}))))}class b{constructor(t,e,s){this.recordedBlobs=[],this.mediaRecorder=null,this.handleDataAvailable=this.handleDataAvailable.bind(this),this.handleStop=this.handleStop.bind(this),this._app=t,this._vbps=s,this.video=document.createElement("video"),this.video.style.display="none",this.stream=e.captureStream(),null!=typeof this.stream&&this.stream}start(){this._app.MSDestination||(this._app.MSDestination=this._app.AC.createMediaStreamDestination());let t=["video/webm","video/webm,codecs=vp9","video/vp8","video/webm;codecs=vp8","video/webm;codecs=daala","video/webm;codecs=h264","video/mpeg"];for(let e in t)if(MediaRecorder.isTypeSupported(t[e])){this.supportedType=t[e];break}null==this.supportedType&&console.log("No supported type found for MediaRecorder");let e={mimeType:this.supportedType,videoBitsPerSecond:this._vbps||25e5,audioBitsPerSecond:this._vbps||25e5};this.recordedBlobs=[];try{const t=new MediaStream;t.addTrack(this.stream.getVideoTracks()[0]),t.addTrack(this._app.MSDestination.stream.getAudioTracks()[0]),this.mediaRecorder=new MediaRecorder(t,e)}catch(t){return alert("MediaRecorder is not supported by this browser."),void console.error("Exception while creating MediaRecorder:",t)}console.log("Created MediaRecorder",this.mediaRecorder,"with options",e),this.mediaRecorder.onstop=this.handleStop,this.mediaRecorder.ondataavailable=this.handleDataAvailable,this.mediaRecorder.start(100),console.log("MediaRecorder started",this.mediaRecorder)}stop(){var t;null===(t=this.mediaRecorder)||void 0===t||t.stop(),console.log("Recorded Blobs: ",this.recordedBlobs),this.video.controls=!0}save(t){const e=t||"recording.webm",s=new Blob(this.recordedBlobs,{type:this.supportedType}),n=window.URL.createObjectURL(s),o=document.createElement("a");o.style.display="none",o.href=n,o.download=e,document.body.appendChild(o),o.click(),setTimeout((()=>{document.body.removeChild(o),window.URL.revokeObjectURL(n)}),100)}handleDataAvailable(t){t.data&&t.data.size>0&&this.recordedBlobs.push(t.data)}handleStop(t){console.log("Recorder stopped: ",t);const e=new Blob(this.recordedBlobs,{type:this.supportedType});this.video.src=window.URL.createObjectURL(e)}}function _(t){t.keys().forEach(t)}_(r(7518)),_(r(266)),r(8860),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/service-worker.js").then((t=>{console.log("SW registered: ",t)})).catch((t=>{console.log("SW registration failed: ",t)}))})),window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},new class{constructor(e){var n,o,i;this.AC=window.AudioContext?new AudioContext:new window.webkitAudioContext,this.MSDestination=null,this.L1C=null,this.L2C=null,this.appState={mouseX:0,mouseY:0,keyPresses:[],animeId:0,resizing:!1,currentTool:0,curPos:0,curScore:{beats:4,end:0,loop:!1,notes:[],tempo:"0"},history:[],gameStatus:t.Edit},this._urlOptions={},this._maxHistory=10,this.ASSETS={BUTTONS:[],SOUNDS:[]},this.TIMERS={},this.canvasRecorder=null,this.getConstants=d.getConstants.bind(this),this.doAnimation=this.doAnimation.bind(this),this.doMarioEnter=this.doMarioEnter.bind(this),this.doMarioLeave=this.doMarioLeave.bind(this),this.doMarioPlay=this.doMarioPlay.bind(this),this._downloadJSON=this._downloadJSON.bind(this),this._downloadMP3=this._downloadMP3.bind(this);const r=this;this.ui=new f.Loader(this),this.soundManager=new s(this);const a=document.querySelector(e);if(!a)throw new Error(`Unable to find selector: ${e}`);{const e=d.getScaledMagnify();a.addEventListener("mp3update",this._onMp3Update),a.classList.add(l),a.style.setProperty("--scaledMagnify",e.toString()),window.location.search.substr(1).split("&").forEach((t=>{const e=t.split("=");this._urlOptions[e[0]]=e[1]})),this.CONST=this.getConstants(this._urlOptions,a),this.curMaxBars=this.CONST.DEFAULTMAXBARS,this.container=a,document.getElementById("magnify").addEventListener("change",(t=>{let e=t.target.selectedIndex+1;this._resizeScreen(e)})),window.addEventListener("resize",(()=>{const t=document.getElementById("magnify");if(t){const e=t.selectedIndex+1;this._resizeScreen(e)}}));const s=document.querySelector("button#dlJSON");s&&s.addEventListener("click",this._downloadJSON);const c=document.querySelector("button#dlMP3");c&&c.addEventListener("click",this._downloadMP3);const u=document.querySelector("button#dismissDL");u&&u.addEventListener("click",(()=>{var t,e;null===(t=document.querySelector("audio#export"))||void 0===t||t.remove(),null===(e=document.querySelector(".downloadOpts"))||void 0===e||e.classList.remove("rendering","dlReady")})),null===(n=document.getElementById("shareLink"))||void 0===n||n.addEventListener("click",(t=>{const e=document.getElementById("shareUrl");document.getElementById("inclSong").checked=!1,e.value=window.location.href})),null===(o=document.getElementById("inclSong"))||void 0===o||o.addEventListener("click",(function(t){const e=document.getElementById("shareUrl");let s=window.location.port,n=`${window.location.protocol}//${window.location.hostname}${"80"!==s?":"+s:""}${window.location.pathname}`;if(this.checked){const t=r.appState.curScore.notes;let e="";t.forEach((t=>{for(let s=0;s<=Math.min(t.length,2);s++){const n=t[s];if(n){const t=1+(255&n),s=1+(n>>8&255);e+=t.toString(16),t>0&&(e+=s.toString(16))}else e+=[...Array(2-s+1)].reduce(((t,e)=>t+"0"),"")}e+="\r"})),n+=`?S=${e}&T=${r.appState.curScore.tempo}&L=${r.appState.curScore.loop?"T":"F"}&E=${r.appState.curScore.end}&B=${4===r.appState.curScore.beats?"T":"F"}`}e.value=n})),null===(i=document.getElementById("shareCopy"))||void 0===i||i.addEventListener("click",(t=>{const e=document.getElementById("shareUrl");e.select(),e.setSelectionRange(0,99999),navigator.clipboard.writeText(e.value)})),this.soundManager.loadSounds().then((()=>{this.ui.init().then((()=>{this.Layer2&&(this.canvasRecorder=new b(this,this.Layer2)),function(e){e.container.addEventListener("playsong",(s=>{var n;const o=document.getElementById("play");o.style.backgroundImage="url("+o.images[1].src+")",o.disabled=!0;const i=document.getElementById("stop");i.style.backgroundImage="url("+i.images[0].src+")",i.disabled=!1,e.ASSETS.SOUNDS[17].play(8),["toLeft","toRight","scroll","clear","frog","beak","1up"].map((function(t){document.getElementById(t).disabled=!0})),e.appState.gameStatus=t.MarioEntering,e.appState.curPos=0,null===(n=e.mario)||void 0===n||n.init(),window.requestAnimFrame(e.doMarioEnter)})),e.container.addEventListener("stopsong",(s=>{var n;const o=document.getElementById("stop");o.style.backgroundImage="url("+o.images[1].src+")",o.disabled=!0,null!=s&&e.ASSETS.SOUNDS[17].play(8);const i=document.getElementById("play");i.style.backgroundImage="url("+i.images[0].src+")",e.appState.gameStatus=t.MarioLeaving,null===(n=e.mario)||void 0===n||n.init4leaving(),0!=e.appState.animeId&&cancelAnimationFrame(e.appState.animeId),window.requestAnimFrame(e.doMarioLeave)}))}(this);const e=document.getElementById("spinner");e&&this.container.removeChild(e),this._actionUrlParams()}))}))}}_actionUrlParams(){const t=this._urlOptions,e=this;try{if(0==Object.keys(t).length)return;if(null!=t.url){this.resetScore();const s=t.url;new Promise((function(t,e){const n=new XMLHttpRequest;n.open("GET",s),n.onload=function(){200==n.status?t(n.response):e(Error(n.statusText))},n.onerror=function(){e(Error("Network Error"))},n.send()})).then((function(n){"msq"==s.slice(-3)?e.addMSQ(n):e.addJSON(n),e._reInitButtonsFromScore(),e._autoPlayIfDemanded(t)})).catch((function(t){alert("Downloading File: "+s+" failed :"+t),console.error("Downloading File: "+s+" failed :"+t.stack)}))}else if(null!=t.S||null!=t.SCORE){const s=t.SCORE||t.S,n=t.TEMPO||t.T;let o=t.LOOP||t.L;const i=t.END||t.E;let r=t.TIME44||t.B;if(null==n||null==o||null==i||null==r)throw new Error("Not enough parameters");o=o.toUpperCase(),r=r.toUpperCase();const a="SCORE="+s+"\nTEMPO="+n+"\nLOOP="+("T"==o||"TRUE"==o?"TRUE":"FALSE")+"\nEND="+i+"\nTIME44="+("T"==r||"TRUE"==r?"TRUE":"FALSE");e.resetScore(),e.addMSQ(a),e._reInitButtonsFromScore(),e._autoPlayIfDemanded(t)}}catch(t){}}resetScore(){this.appState.curScore.notes=[],this.curMaxBars=0,this.appState.curScore.beats=4,this.appState.curScore.end=0,this.appState.curScore.tempo=0}initMusicScore(){var t;const{DEFAULTMAXBARS:e,DEFAULTTEMPO:s}=this.CONST,n=[];for(let t=0;t<e;t++)n[t]=[];this.appState.curScore.notes=n,this.curMaxBars=e;const o=document.getElementById("scroll");o.max=(e-6).toString(),o.value="0",this.appState.curScore.loop=!1,null===(t=document.getElementById("loop"))||void 0===t||t.reset(),this.appState.curScore.end=e-1,this.appState.curScore.tempo=s;const i=document.getElementById("tempo");i&&(i.value=s.toString()),this.appState.curScore.beats=4;const r=new Event("click");r.soundOff=!0;const a=document.getElementById("4beats");a&&a.dispatchEvent(r)}_reInitButtonsFromScore(){const t=document.getElementById(3==this.appState.curScore.beats?"3beats":"4beats"),e=new Event("click");e.soundOff=!0,t.dispatchEvent(e);const s=document.getElementById("scroll");this.curMaxBars=this.appState.curScore.end+1,s.max=(this.curMaxBars-6).toString(),s.value="0",this.appState.curPos=0;const n=document.getElementById("tempo");let o=this.appState.curScore.notes[0][0];"string"==typeof o&&"TEMPO"==o.substr(0,5)&&(o=o.split("=")[1],this.appState.curScore.tempo=o,n.value=o)}addMSQ(t){const e=t.split(/\r\n|\r|\n/),s=["SCORE","TEMPO","LOOP","END","TIME44"],n={};e.forEach((function(t,e){if(""===t)return;const o=t.split("="),i=o[0],r=o[1];if(e<s.length&&i!==s[e])throw new Error("Line "+e+" must start with '"+s[e]+"'");n[i]=r}));const o=this.appState.curScore.end,i=n.SCORE;let r=0,a=this.appState.curScore.end;t:for(;r<i.length;){const t=[];for(let e=0;e<3;e++){if("\r"===i[r]||null==i[r])break t;let e=parseInt(i[r++],16);if(0!==e){e-=1;const s=parseInt(i[r++],16)-1<<8|e;t.push(s)}}this.appState.curScore.notes[a++]=t}this.appState.curScore.end+=parseInt(n.END)-1,this.appState.curScore.tempo!=n.TEMPO&&this.appState.curScore.notes[o].splice(0,0,"TEMPO="+n.TEMPO),this.appState.curScore.tempo=n.TEMPO;const c="TRUE"==n.TIME44?4:3;this.appState.curScore.beats=c;const u=document.getElementById("loop");"TRUE"==n.LOOP?u.set():u.reset()}addJSON(t){const e=JSON.parse(t);for(let t=0;t<e.end;t++)this.appState.curScore.notes.push(e.notes[t]);const s=this.appState.curScore.notes[this.appState.curScore.end];this.appState.curScore.tempo!=e.tempo&&0!=s.length&&"string"!=typeof s[0]&&s.splice(0,0,"TEMPO="+e.tempo),this.appState.curScore.tempo=e.tempo,this.appState.curScore.end+=e.end;const n=document.getElementById("loop");this.appState.curScore.loop?n.set:n.reset()}updateHistory(){this.appState.history.push(Object.assign({},this.appState)),this.appState.history.length>this._maxHistory&&(this.appState.history=this.appState.history.slice(0-this._maxHistory))}drawScore(e,s,n){const{CHARSIZE:o,HALFCHARSIZE:i,MAGNIFY:r,OFFSETLEFT:a,OFFSETTOP:c,SCRHEIGHT:u}=this.CONST,{IMAGES:d,SOUNDS:l}=this.ASSETS,p=this.Layer2;if(this.mario&&d&&p&&this.L1C&&this.L2C){this.L2C.clearRect(0,0,p.width,p.height),this.L2C.save(),this.L2C.rect(8*r,0,240*r,u*r),this.L2C.clip();const h=this.appState.mouseX-a,S=this.appState.mouseY-c,m=this.ui.toGrid(h,S);let g,f;if(this.appState.gameStatus==t.Edit&&!1!==m&&(g=m[0],f=m[1],f>=11&&this._drawHorizontalBar(g,0)),this.ASSETS.IMAGES&&0==e){const t=this.ASSETS.IMAGES.GClef.width,e=this.ASSETS.IMAGES.GClef.height;this.L2C.drawImage(this.ASSETS.IMAGES.GClef,0,0,t,e,(9-n)*r,48*r,t*r,e*r),this.appState.curScore.loop&&this._drawRepeatHead(41-n)}else 1==e&&this.appState.curScore.loop&&this._drawRepeatHead(9-n);const v=this.appState.curScore.beats,w=4==v?3-(e+1)%4:2-(e+3)%3;let y=e<2?2-e:0;for(;y<9;y++){const o=16+32*y-n,a=o*r,c=e+y-2;if(c==this.appState.curScore.end){const t=this.appState.curScore.loop?d.Repeat[1]:d.EndMark;this.L2C.drawImage(t,a-7*r,56*r)}this.L2C.beginPath(),this.L2C.setLineDash([r,r]),this.L2C.lineWidth=r,y%v==w?(this.appState.gameStatus==t.Edit&&this._drawBarNumber(y,c/v+1),this.L2C.strokeStyle="#F89000"):this.L2C.strokeStyle="#A0C0B0",this.L2C.moveTo(a,41*r),this.L2C.lineTo(a,148*r),this.L2C.stroke();const u=s[c];if(null==u)continue;let p=0;if(this.appState.gameStatus==t.Playing&&this.mario.pos-2==c){let t;t=120==this.mario.x?this.mario.scroll>=16?this.mario.scroll-16:this.mario.scroll+16:this.mario.x+8-o,p=[0,1,2,3,3,4,5,5,6,6,7,7,8,8,8,8,8,8,8,8,8,7,7,6,6,5,5,4,3,3,2,1,0][Math.round(t)]}let h=!1;for(let t=0;t<u.length;t++){const e=u[t];if("string"==typeof e)continue;const s=e>>8,o=15&e;if(16==this.appState.currentTool&&0!=m&&y==g&&o==f&&1==this.TIMERS.eraser.currentFrame)continue;!h&&o>=11&&(h=!0,this._drawHorizontalBar(y,n));const c=l[s].image;c&&this.L2C.drawImage(c,a-i,(40+8*o+p)*r);const S=a-13*r,v=(44+8*o+p)*r;0!=(128&e)?this.L2C.drawImage(d.Semitone[0],S,v):0!=(64&e)&&this.L2C.drawImage(d.Semitone[1],S,v)}}if(this.appState.gameStatus==t.Edit&&g&&f){this.L2C.beginPath(),this.L2C.setLineDash([7*r,2*r,7*r,0]),this.L2C.lineWidth=r,this.L2C.strokeStyle="#F00";const t=(16+32*g-8)*r,e=(40+8*f)*r;this.L2C.rect(t,e,o,o),this.L2C.stroke()}this.L2C.restore()}}_drawHorizontalBar(t,e){var s;const{HALFCHARSIZE:n,MAGNIFY:o}=this.CONST,i=24*o;null===(s=this.L2C)||void 0===s||s.fillRect((4+32*t-e)*o,126*o+n,i,2*o)}_drawRepeatHead(t){const{MAGNIFY:e}=this.CONST,{IMAGES:s}=this.ASSETS;this.L2C&&s&&(s.Repeat[0].width,s.Repeat[0].height,this.L2C.drawImage(s.Repeat[0],t*e,56*e))}drawEndMarkIcon(t){const{MAGNIFY:e}=this.CONST;this.L1C&&(this.L1C.clearRect(4*e,8*e,16*e,14*e),this.L1C.drawImage(t,5*e,8*e))}_drawBarNumber(t,e){const{MAGNIFY:s}=this.CONST,{IMAGES:n}=this.ASSETS;if(n&&this.L2C){let o=(16+32*t)*s-1;const i=33*s,r=[];for(;e>0;)r.push(e%10),e=Math.floor(e/10);for(1==r.length&&(o+=2*s);r.length>0;){const t=r.pop();if(void 0!==t){const e=4==t?5:4;this.L2C.drawImage(n.Numbers[t],o,i,5*s,7*s),o+=e*s}}}}drawEraserIcon(){const{MAGNIFY:t}=this.CONST;this.L1C&&this.L1C.clearRect(4*t,8*t,16*t,14*t)}drawMario(t,e,s){const{MAGNIFY:n}=this.CONST;this.L2C&&this.L2C.drawImage(t,e*n,s*n)}drawMarioSweat(t,e,s,n,o,i,r,a,c){const{MAGNIFY:u}=this.CONST;this.L2C&&this.L2C.drawImage(t,e,s,n,o,i*u,r*u,a*u,c*u)}_autoPlayIfDemanded(t){let e=t.a||t.auto;if(null!=e&&(e=e.toUpperCase(),"T"==e||"TRUE"==e)){const t=document.getElementById("play");t&&t.dispatchEvent(new Event("click"))}}doMarioEnter(e){this.TIMERS.bomb.checkAndFire(e),this.drawScore(0,this.appState.curScore.notes,0),this.mario&&(this.mario.enter(e),this.mario.x<40?this.appState.animeId=window.requestAnimFrame(this.doMarioEnter):(this.mario.init4playing(e),this.appState.gameStatus=t.Playing,this.appState.animeId=window.requestAnimFrame(this.doMarioPlay)))}doMarioPlay(e){this.TIMERS.bomb.checkAndFire(e),this.mario&&(this.mario.play(e),this.appState.gameStatus==t.Playing)&&(this.mario.pos-2!=this.appState.curScore.end-1?this.appState.animeId=window.requestAnimFrame(this.doMarioPlay):this.appState.curScore.loop?(this.appState.curPos=0,this.mario.pos=1,this.mario.x=40,this.mario.init4playing(e),this.appState.animeId=window.requestAnimFrame(this.doMarioPlay)):c(document.getElementById("stop"),!0))}doMarioLeave(e){this.TIMERS.bomb.checkAndFire(e),this.mario&&(this.drawScore(this.appState.curPos,this.appState.curScore.notes,this.mario.scroll),this.mario.leave(e),this.mario.x<247?window.requestAnimFrame(this.doMarioLeave):(this.appState.gameStatus=t.Edit,["toLeft","toRight","scroll","play","clear","frog","beak","1up"].map((function(t){document.getElementById(t).disabled=!1})),window.requestAnimFrame(this.doAnimation)))}doAnimation(e){var s,n,o;(this.appState.resizing||(null===(s=this.TIMERS.bomb)||void 0===s||s.checkAndFire(e),null===(n=this.TIMERS.eraser)||void 0===n||n.checkAndFire(e),null===(o=this.TIMERS.endMark)||void 0===o||o.checkAndFire(e),this.drawScore(this.appState.curPos,this.appState.curScore.notes,0),this.appState.gameStatus==t.Edit))&&window.requestAnimFrame(this.doAnimation)}scheduleAndPlay(t,e){const{SOUNDS:s}=this.ASSETS;if(e<0&&(e=0),null==t||0==t.length)return;const n={};for(let e=0;e<t.length;e++){const s=t[e];if("string"==typeof s){const t=s.split("=")[1];this.appState.curScore.tempo=t;const e=document.getElementById("tempo");e&&(e.value=t);continue}const o=s>>8,i=255&s;n[o]?n[o].push(i):n[o]=[i]}for(let t in n)s[t].playChord(n[t],e/1e3)}resizeDOM(t,e,s){const{MAGNIFY:n}=this.CONST;t.style.width=e*n+"px",t.style.height=s*n+"px"}moveDOM(t,e,s){const{MAGNIFY:n}=this.CONST;t.style.left=e*n+"px",t.style.top=s*n+"px"}_resizeScreen(t){return e=this,s=void 0,o=function*(){let{CHARSIZE:e,HALFCHARSIZE:s,MAGNIFY:n,ORGWIDTH:o,ORGHEIGHT:i,OFFSETLEFT:r,OFFSETTOP:a,SCRHEIGHT:c}=this.CONST;this.appState.resizing=!0;let u=t;const l=d.getScaledMagnify();if(t>3&&(u=l),n=u,e=16*n,s=Math.floor(e/2),this.container.style.width=o*n+"px",this.container.style.height=i*n+"px",this.container.style.setProperty("--scaledMagnify",t>3?l.toString():"0"),r=this.container.offsetLeft,a=this.container.offsetTop,this.container)switch(this.container.classList.remove(p,h,S),u){case 1:this.container.classList.add(p);break;case 2:this.container.classList.add(h);break;case 3:this.container.classList.add(S)}(()=>{this.L1C&&this.L1C.clearRect(0,0,o*n,i*n),this.L2C&&this.L2C.clearRect(0,0,o*n,c*n)})(),this.CONST=Object.assign(Object.assign({},this.CONST),{CHARSIZE:e,HALFCHARSIZE:s,MAGNIFY:n,OFFSETLEFT:r,OFFSETTOP:a}),yield new f.Loader(this).init(!0),this.container.querySelectorAll('button.game, input[type="range"]').forEach((t=>{t.redraw()})),this.ui.changeCursor(this.appState.currentTool),this.appState.resizing=!1},new((n=void 0)||(n=Promise))((function(t,i){function r(t){try{c(o.next(t))}catch(t){i(t)}}function a(t){try{c(o.throw(t))}catch(t){i(t)}}function c(e){var s;e.done?t(e.value):(s=e.value,s instanceof n?s:new n((function(t){t(s)}))).then(r,a)}c((o=o.apply(e,s||[])).next())}));var e,s,n,o}_downloadJSON(){const t=document.createElement("a");t.download="MSQ_Data.json";const e=JSON.stringify(this.appState.curScore),s=new Blob([e],{type:"octet/stream"}),n=window.URL.createObjectURL(s);t.href=n,t.click()}_downloadMP3(){document.querySelector(".downloadOpts").classList.remove("rendering","dlReady"),function(t){return v(this,void 0,void 0,(function*(){const{curScore:e}=t.appState,{notes:s,end:n,tempo:o}=e,i=n/(Number(o)/60),r=i/n,a=new OfflineAudioContext(2,44100*i,44100);for(let t=0;t<i;t+=2)a.suspend(t);a.onstatechange=function(e){if("suspended"===a.state){const e=new Event("mp3update");e.data={type:"songProgressUpdate",value:a.currentTime/i},t.container.dispatchEvent(e),a.resume()}},a.oncomplete=function(e){const s=new Event("mp3update");s.data={type:"songProgressUpdate",value:1},t.container.dispatchEvent(s)};const c=a.destination,u=s.map((t=>function(t){const e={};return t.forEach(((t,s)=>{if("string"==typeof t)return;const n=t>>8,o=255&t;e[n]?e[n].push(o):e[n]=[o]})),e}(t)));for(let e=0;e<n;e++){let o;if(0===s[e].length)continue;o=yield w(t,u[e],u[e+1],r,e+1,n);const i=a.createBufferSource();i.buffer=o,i.connect(c),i.start(e*r)}const d=yield a.startRendering(),l=new Blob([yield E(d)],{type:"audio/mp3"});return URL.createObjectURL(l)}))}(this).then((t=>{const e=new Event("mp3update");e.data={type:"song",value:t},this.container.dispatchEvent(e)}))}_onMp3Update(t){const e=document.querySelector(".downloadOpts"),s=document.querySelector("progress");switch(t.data.type){case"chordGenUpdate":case"songProgressUpdate":e.classList.contains("rendering")||e.classList.add("rendering"),s.value=100*t.data.value;break;case"song":e.classList.contains("dlReady")||(e.classList.remove("rendering"),e.classList.add("dlReady"));let n=e.querySelector("#export");n||(n=document.createElement("audio"),n.id="export",n.controls=!0,e.appendChild(n)),n.src=t.data.value}}setState(t){this.updateHistory(),this.appState=Object.assign(this.appState,t)}}("#app")})()})();